---
layout: post
title: Docker container can't resolve internal DNS addresses on Ubuntu host
---

## The problem  
According to [this answer](https://serverfault.com/a/918568) on [Server Fault](https://serverfault.com/), Ubuntu 18.04 (and future versions) now uses a local DNS cache by default, `127.0.0.53`.
This nameserver will not work inside a Docker container, so Docker defaults to Google’s DNS, `8.8.8.8`.
This means your Docker containers can’t resolve domain names that depend on an internal DNS.

## The solution  
The `/etc/resolv.conf` file is now generated by systemd-resolved and masks the actual DNS configuration.
The original configuration still exists however, and it’s located at `/run/systemd/resolve/resolv.conf`.
The default `/etc/resolv.conf` is a symlink to `/run/systemd/resolve/stub-resolv.conf`.

To fix the issue, simply change the simlink like so:
```bash
sudo mv /etc/resolv.conf /etc/resolv.conf.old
sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
```

The domain should now resolve correctly!
```bash
$ docker run debian ping <internal_url>
PING <internal_hostname> (192.168.0.202) 56(84) bytes of data.
64 bytes from <internal_hostname> (192.168.0.202): icmp_seq=1 ttl=63 time=0.911 ms
```

## The story  
While setting up a docker container that has to resolve an address through an internal DNS server I found that it couldn’t resolve the address.
When I tried, it just returned something like this:
```bash
$ docker run debian ping <internal_url>
ping: <internal_url>: Name or service not known
```

You can specify the DNS manually by using the DNS flag `docker run --dns <internal_dns_ip> debian ping <internal_url>` so I tried that.
First, let’s find the DNS IP.

Ubuntu has a file on it’s system for DNS configurations: `/etc/resolv.conf`.
Looking at that file gave me an IP address:

```conf
# This file is managed by man:systemd-resolved(8). Do not edit.
#
# This is a dynamic resolv.conf file for connecting local clients to the
# internal DNS stub resolver of systemd-resolved. This file lists all
# configured search domains.
#
# Run "systemd-resolve --status" to see details about the uplink DNS servers
# currently in use.
#
# Third party programs must not access this file directly, but only through the
# symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a different way,
# replace this symlink by a static file or a different symlink.
#
# See man:systemd-resolved.service(8) for details about the supported modes of
# operation for /etc/resolv.conf.

nameserver 127.0.0.53
search fcmd.local
```

As we can see here, it says the nameserver it’s using is “127.0.0.53”, so I try that:
```bash
$ docker run --dns 127.0.0.53 debian ping <internal_url.com>
WARNING: Localhost DNS setting (--dns=127.0.0.53) may fail in containers.
ping: <internal_url.com>: Temporary failure in name resolution
```

After trying a whole bunch of different variations of this, and a lot of googling, I found a question on [Server Fault](https://serverfault.com/), where someone had a similar issue.
[An answer](https://serverfault.com/a/918568) posted there finally solved my issue.

Ubuntu 18.04, and future versions, now use a local DNS cache generated by systemd-resolved and the `/etc/resolv.conf` uses the internal DNS settings.
To find the real settings you must look at `/run/systemd/resolve/resolv.conf`.
That’s where the real DNS config is located, not the generated local DNS config.

To fix the issue, simply run
```bash
sudo mv /etc/resolv.conf /etc/resolv.conf.old
sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
```
